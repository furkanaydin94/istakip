<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İş Takip Sistemi - Gruplama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; min-height: 100vh; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px;}
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .glass { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 16px; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); }
        .voyage-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; transition: all 0.2s ease; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); }
        .voyage-card:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.06); border-color: #93c5fd; } /* Daha yumuşak hover */
        .kanban-board { display: grid; grid-auto-columns: minmax(320px, 1fr); grid-auto-flow: column; gap: 1.5rem; overflow-x: auto; padding-bottom: 1rem; }
        .kanban-column { background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;} /* Sütunlara arka plan */
        .kanban-tasks { display: grid; grid-template-columns: 1fr; gap: 1rem; align-content: start; }
        .priority-critical { border-left: 3px solid #ef4444; }
        .priority-high { border-left: 3px solid #f97316; }
        .priority-normal { border-left: 3px solid #3b82f6; }
        .priority-low { border-left: 3px solid #22c55e; }
        .badge { padding: 3px 10px; border-radius: 9999px; font-size: 0.7rem; font-weight: 500; display: inline-flex; align-items: center; gap: 4px; border: 1px solid transparent; line-height: 1.2; } /* Daha küçük badge */
        .badge-critical { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }
        .badge-high { background: #ffedd5; color: #c2410c; border-color: #fed7aa; }
        .badge-normal { background: #dbeafe; color: #1d4ed8; border-color: #bfdbfe; }
        .badge-low { background: #dcfce7; color: #15803d; border-color: #bbf7d0; }
        .badge-status { background: #e0f2fe; color: #0369a1; border-color: #bae6fd;} /* Genel durum badge stili */
        .badge-trigger { background: #f3e8ff; color: #7e22ce; border-color: #e9d5ff;}
        .badge-department { background: #e0e7ff; color: #4338ca; border-color: #c7d2fe;}
        .modal-backdrop { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); animation: fadeIn 0.3s ease; }
        .modal-content { animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); max-width: 60rem; } /* Modal genişliği ayarlandı */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .tab-btn { transition: all 0.2s ease; position: relative; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #3b82f6; color: #3b82f6;}
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #60a5fa, #3b82f6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 13px; border: 2px solid white; } /* Avatar boyutu ayarlandı */
        .loading-spinner { border: 3px solid rgba(59, 130, 246, 0.1); border-top-color: #3b82f6; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .line-clamp-1 { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        #filter-menu { transition: transform 0.3s ease-in-out; transform: translateX(100%); box-shadow: -10px 0 20px rgba(0,0,0,0.1); }
        #filter-menu.open { transform: translateX(0); }
        .filter-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #475569; font-size: 0.875rem; }
        .filter-group select, .filter-group input { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #cbd5e1; border-radius: 8px; background-color: #f8fafc; color: #1e293b; font-size: 0.875rem; }
        .card-field { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: #475569; }
        .card-field i { width: 1rem; text-align: center; color: #94a3b8; } /* Icon rengi açıldı */
        .card-field span { flex: 1; min-width: 0; }
        .card-field strong { font-weight: 500; color: #334155; } /* Kalınlık azaltıldı */
        .summary-card { cursor: pointer; }
        .summary-card:hover { border-color: #93c5fd; background-color: #f0f9ff;}
        .status-count-item, .priority-count-item { cursor: pointer; transition: background-color 0.2s ease; }
        .status-count-item:hover, .priority-count-item:hover { background-color: #e0f2fe;} /* Hover efekti */
        .grouping-controls button { transition: all 0.2s ease; }
        .grouping-controls button.active { background-color: #3b82f6; color: white; }
         /* Header yüksekliğini hesaba katan padding */
         #main-content { padding-top: 140px; } /* Yaklaşık header yüksekliği */

         .document-card:hover {
            transform: none; /* Hover'da büyüme efekti kaldırıldı */
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* Normal gölge */
            border-color: #93c5fd; /* Sadece border rengi */
        }
         /* Başlık için stil */
         .view-title {
             font-size: 1.5rem; /* 24px */
             font-weight: 600;
             color: #1e293b; /* slate-800 */
             margin-bottom: 1.5rem; /* 24px */
         }
         /* Geri butonu */
         .back-button {
             display: inline-flex;
             align-items: center;
             gap: 0.5rem;
             font-size: 0.875rem;
             color: #475569;
             margin-bottom: 1rem;
             padding: 0.25rem 0.5rem;
             border-radius: 6px;
             transition: background-color 0.2s ease;
         }
         .back-button:hover {
             background-color: #f1f5f9;
         }
    </style>
</head>
<body>
    <div id="loading-overlay" class="fixed inset-0 bg-slate-100 flex flex-col items-center justify-center z-[100]">
        <div class="loading-spinner"></div>
        <p class="mt-4 text-sm font-medium text-slate-600">Veriler yükleniyor...</p>
        <div id="loading-progress" class="mt-2 text-xs text-slate-500"></div>
    </div>

    <header class="fixed top-0 left-0 right-0 z-40 bg-white/95 backdrop-blur-sm border-b border-slate-200">
        <div class="flex items-center justify-between px-6 py-3">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center">
                    <i class="ph-bold ph-kanban text-lg text-white"></i>
                </div>
                <div>
                    <h1 class="text-lg font-semibold text-slate-800">İş Takip Sistemi</h1>
                    <p class="text-xs text-slate-500">Özet & Detay Görünümü</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="relative">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="search-input" placeholder="Görevlerde ara..." class="w-72 bg-slate-100 border border-slate-200 text-slate-700 rounded-lg pl-9 pr-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition placeholder-slate-400">
                </div>
                <button id="sync-btn" title="Verileri Yenile" class="bg-slate-100 hover:bg-slate-200 p-2 rounded-lg transition border border-slate-200 text-slate-600">
                    <i class="ph-bold ph-arrows-clockwise text-lg"></i>
                </button>
                <div id="last-sync" class="text-xs text-slate-500 hidden whitespace-nowrap">
                    <span id="sync-time"></span>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-between px-6 py-2 border-t border-slate-200">
            <div class="flex items-center gap-2">
                <button id="view-toggle-kanban" class="view-btn px-3 py-1.5 rounded-md font-medium text-sm flex items-center gap-1.5 text-slate-600 hover:bg-slate-100">
                    <i class="ph ph-trello-logo"></i> Pano
                </button>
                <button id="view-toggle-list" class="view-btn px-3 py-1.5 rounded-md font-medium text-sm flex items-center gap-1.5 text-slate-600 hover:bg-slate-100">
                    <i class="ph ph-list-bullets"></i> Liste
                </button>
                <button id="view-grouping" class="view-btn px-3 py-1.5 rounded-md font-medium text-sm flex items-center gap-1.5 text-slate-600 hover:bg-slate-100">
                    <i class="ph ph-chart-pie-slice"></i> Grupla
                </button>
                 <button id="view-docs" class="view-btn px-3 py-1.5 rounded-md font-medium text-sm flex items-center gap-1.5 text-slate-600 hover:bg-slate-100">
                    <i class="ph ph-files"></i> Belgeler
                </button>
            </div>

            <div class="flex items-center gap-3">
                <button id="open-filter-btn" class="bg-white hover:bg-slate-50 border border-slate-200 text-slate-700 px-3 py-1.5 rounded-md transition flex items-center gap-1.5 text-sm font-medium">
                    <i class="ph ph-funnel text-base"></i> Filtrele
                </button>
                <div id="active-filter-count" class="text-xs bg-blue-100 text-blue-700 rounded-full px-2 py-0.5 font-medium hidden">0 Aktif</div>
            </div>
        </div>
    </header>

    <main id="main-content" class="px-6 pb-8">
        <!-- Dinamik içerik buraya yüklenecek --></main>

    <div id="filter-menu-backdrop" class="fixed inset-0 bg-black/30 z-50 hidden opacity-0 transition-opacity duration-300"></div>
    <div id="filter-menu" class="fixed top-0 right-0 bottom-0 w-80 bg-white shadow-xl z-[60] transform translate-x-full transition-transform duration-300 flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-slate-200">
            <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                <i class="ph ph-funnel text-blue-600"></i> Filtreleme
            </h2>
            <button id="close-filter-btn" class="p-1 rounded-full hover:bg-slate-100 text-slate-500 hover:text-slate-700">
                <i class="ph ph-x text-xl"></i>
            </button>
        </div>

        <div class="flex-grow p-4 overflow-y-auto space-y-4">
             <!-- Filtreler --><div class="filter-group">
                <label for="filter-talepEden">Talep Eden Makam</label>
                <select id="filter-talepEden"></select>
            </div>
            <div class="filter-group">
                <label for="filter-kaynak">Kaynak / Harici Paydaş</label>
                <select id="filter-kaynak"></select>
            </div>
            <div class="filter-group">
                <label for="filter-ilgiliDepartman">İlgili Departman</label>
                <select id="filter-ilgiliDepartman"></select>
            </div>
            <div class="filter-group">
                <label for="filter-tetiklenmeTuru">Tetiklenme Türü</label>
                <select id="filter-tetiklenmeTuru"></select>
            </div>
            <div class="filter-group">
                <label for="filter-gorevTipi">Görev Tipi</label>
                <select id="filter-gorevTipi"></select>
            </div>
            <div class="filter-group">
                <label for="filter-oncelik">Öncelik</label>
                <select id="filter-oncelik"></select>
            </div>
            <div class="filter-group">
                <label for="filter-mevcutDurum">Mevcut Durum</label>
                <select id="filter-mevcutDurum"></select>
            </div>
            <div class="filter-group">
                <label for="filter-sorumlu">Sorumlular</label>
                <select id="filter-sorumlu"></select>
            </div>
        </div>

        <div class="p-4 border-t border-slate-200 flex justify-end gap-2">
            <button id="reset-filters-btn" class="px-4 py-2 rounded-lg text-sm font-medium bg-slate-100 hover:bg-slate-200 text-slate-700 transition">Sıfırla</button>
            <button id="apply-filters-btn" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 hover:bg-blue-700 text-white transition">Uygula</button>
        </div>
    </div>

    <div id="task-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
        <div class="modal-content glass rounded-xl shadow-xl w-full flex flex-col overflow-hidden max-h-[85vh]">
            <div class="flex justify-between items-start p-5 border-b border-slate-200">
                <div class="flex-1 mr-4">
                    <div class="flex items-center gap-3 mb-1.5">
                        <h2 id="modal-title" class="text-2xl font-semibold text-slate-800"></h2>
                        <span id="modal-priority-badge" class="badge"></span>
                    </div>
                    <div class="flex items-center gap-3 text-xs text-slate-500">
                        <span class="flex items-center gap-1">
                            <i class="ph ph-hash"></i>
                            <span id="modal-id" class="font-mono"></span>
                        </span>
                        <span id="modal-status-badge" class="badge"></span>
                        <span id="modal-trigger-type" class="badge"></span>
                    </div>
                </div>
                <button id="close-modal" class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg p-1.5 transition">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-5">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
                    <div class="lg:col-span-1 space-y-4">
                         <div class="glass rounded-lg p-4">
                            <h3 class="font-semibold text-base mb-3 flex items-center gap-2 text-blue-700">
                                <i class="ph-bold ph-info"></i> Görev Detayları
                            </h3>
                            <div id="modal-details" class="space-y-2.5 text-sm text-slate-700"></div>
                        </div>

                         <div class="glass rounded-lg p-4">
                            <h3 class="font-semibold text-base mb-3 flex items-center gap-2 text-purple-700">
                                <i class="ph-bold ph-users"></i> Ekip & Onay
                            </h3>
                            <div id="modal-team" class="space-y-2.5 text-sm text-slate-700"></div>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                         <div class="glass rounded-lg overflow-hidden">
                             <div class="border-b border-slate-200 px-5 pt-3">
                                <nav id="modal-tabs" class="flex gap-5">
                                     <button data-tab="workflow" class="tab-btn active pb-2 px-1 font-medium text-sm text-slate-700">
                                        <i class="ph ph-flow-arrow mr-1"></i> İş Akışı
                                    </button>
                                     <button data-tab="docs" class="tab-btn pb-2 px-1 font-medium text-sm text-slate-500 hover:text-slate-700">
                                        <i class="ph ph-files mr-1"></i> Belgeler
                                    </button>
                                </nav>
                            </div>
                             <div id="tab-content" class="p-5 min-h-[300px]">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const SHEET_URLS = {
        gorevler: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTlAI9WzClZeiHte_Mpx4EklPbcRByHTBAUVjoHerT39dNbmAwFXiRp6ITIIj92IW9-SijJAxFMnh4z/pub?gid=0&single=true&output=tsv",
        belgeler: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTlAI9WzClZeiHte_Mpx4EklPbcRByHTBAUVjoHerT39dNbmAwFXiRp6ITIIj92IW9-SijJAxFMnh4z/pub?gid=248304037&single=true&output=tsv",
        kayitZinciri: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTlAI9WzClZeiHte_Mpx4EklPbcRByHTBAUVjoHerT39dNbmAwFXiRp6ITIIj92IW9-SijJAxFMnh4z/pub?gid=337730490&single=true&output=tsv"
    };

    let allTasks = []; // Tüm görevleri saklamak için
    let documents = [];
    let kayitZinciri = [];
    let people = new Set();
    let departments = new Set();
    let currentView = 'kanban'; // Varsayılan görünüm
    let currentGroupingType = 'person'; // 'person' or 'department'
    let currentGroupDetail = null; // Hangi grubun detayının gösterildiğini tutar { type, name }
    let lastSyncTime = null;

    // --- DOM Elementleri ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingProgress = document.getElementById('loading-progress');
    const mainContent = document.getElementById('main-content');
    const searchInput = document.getElementById('search-input');
    const taskModal = document.getElementById('task-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const syncBtn = document.getElementById('sync-btn');
    const lastSyncDiv = document.getElementById('last-sync');
    const syncTimeSpan = document.getElementById('sync-time');
    const modalTabs = document.getElementById('modal-tabs');
    const tabContent = document.getElementById('tab-content');
    const filterMenu = document.getElementById('filter-menu');
    const filterMenuBackdrop = document.getElementById('filter-menu-backdrop');

    // --- Yardımcı Fonksiyonlar ---
    function parseCustomDate(dateStr) {
        if (!dateStr) return null;
        const formats = [
            /^(\d{1,2})\.(\d{1,2})\.(\d{4})\s+(\d{1,2}):(\d{1,2}):(\d{1,2})$/, // DD.MM.YYYY HH:MM:SS
            /^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{1,2}):(\d{1,2})$/, // DD/MM/YYYY HH:MM:SS
            /^(\d{1,2})\.(\d{1,2})\.(\d{4})$/, // DD.MM.YYYY
            /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/  // DD/MM/YYYY
        ];
        for (const format of formats) {
            const match = dateStr.match(format);
            if (match) {
                if (match.length > 4) { // Time included
                    const [, day, month, year, hour, minute, second] = match;
                    return new Date(year, month - 1, day, hour, minute, second);
                } else { // Date only
                    const [, day, month, year] = match;
                    return new Date(year, month - 1, day);
                }
            }
        }
        const standardDate = new Date(dateStr); // Try standard parsing
        if (!isNaN(standardDate)) return standardDate;
        console.warn("Could not parse date:", dateStr);
        return null;
    }

    function getPriorityClass(priority) {
        if (!priority) return 'border-l-3 border-slate-300';
        priority = String(priority).toLowerCase();
        if (priority.includes('kritik')) return 'priority-critical';
        if (priority.includes('yüksek')) return 'priority-high';
        if (priority.includes('normal')) return 'priority-normal';
        if (priority.includes('düşük')) return 'priority-low';
        return 'border-l-3 border-slate-300';
    }

    function getPriorityBadge(priority, small = false) {
        const sizeClass = small ? '!py-0.5 !px-2 !text-xs' : ''; // Smaller badge style
        if (!priority) return '';
        priority = String(priority).toLowerCase();
        if (priority.includes('kritik')) return `<span class="badge badge-critical ${sizeClass}">🔴 Kritik</span>`;
        if (priority.includes('yüksek')) return `<span class="badge badge-high ${sizeClass}">🟠 Yüksek</span>`;
        if (priority.includes('normal')) return `<span class="badge badge-normal ${sizeClass}">🟡 Normal</span>`;
        if (priority.includes('düşük')) return `<span class="badge badge-low ${sizeClass}">🔵 Düşük</span>`;
        return `<span class="badge bg-slate-100 text-slate-600 border border-slate-300 ${sizeClass}">${priority}</span>`;
    }

    function getStatusBadge(status, small = false) {
        const sizeClass = small ? '!py-0.5 !px-2 !text-xs' : '';
        if (!status) return `<span class="badge bg-slate-100 text-slate-600 border border-slate-300 ${sizeClass}">-</span>`;
        // Potential: Add color coding based on status keywords
        return `<span class="badge badge-status ${sizeClass}">${status}</span>`;
    }

    // --- Veri Çekme ve İşleme ---
    async function fetchData() {
        loadingOverlay.style.display = 'flex'; // Use style.display
        loadingProgress.textContent = 'Bağlantı kuruluyor...';

        try {
            const promises = Object.entries(SHEET_URLS).map(([key, url]) =>
                new Promise((resolve, reject) => {
                    loadingProgress.textContent = `${key} verileri yükleniyor...`;
                    Papa.parse(url, {
                        download: true, header: true, delimiter: '\t', skipEmptyLines: true,
                        complete: results => {
                             const cleanedData = results.data.map(row => {
                                let newRow = {};
                                Object.keys(row).forEach(k => {
                                    const cleanKey = k.trim(); // Trim key
                                    newRow[cleanKey] = (typeof row[k] === 'string') ? row[k].trim() : row[k];
                                });
                                // Ensure critical IDs are strings
                                if (newRow['İş ID']) newRow['İş ID'] = String(newRow['İş ID']);
                                if (newRow['Mesaj ID']) newRow['Mesaj ID'] = String(newRow['Mesaj ID']);
                                if (newRow['Yanıtlanan Mesaj ID']) newRow['Yanıtlanan Mesaj ID'] = String(newRow['Yanıtlanan Mesaj ID']);
                                return newRow;
                            });
                            resolve({ key, data: cleanedData });
                        },
                        error: err => { console.error(`Error loading ${key}:`, err); reject(new Error(`Failed to load ${key}`));}
                    });
                })
            );

            loadingProgress.textContent = 'Veriler işleniyor...';
            const results = await Promise.all(promises);
            results.forEach(({ key, data }) => {
                switch (key) {
                    case 'gorevler': allTasks = data.filter(t => t['İş ID']); break; // Store all tasks
                    case 'belgeler': documents = data; break;
                    case 'kayitZinciri': kayitZinciri = data; break;
                }
            });

            loadingProgress.textContent = 'Veriler eşleştiriliyor...';
            await processDataWithMatching();

            loadingProgress.textContent = 'Arayüz hazırlanıyor...';
            setupFilters(); // Filtreleri doldur
            applyAndRender(); // Filtreleri uygula ve ilk render'ı yap

            lastSyncTime = new Date();
            updateSyncIndicator();

        } catch (error) {
            console.error('Data fetch error:', error);
            loadingProgress.innerHTML = `<span class="text-red-500">❌ Veri yüklenemedi: ${error.message}</span>`;
            setTimeout(() => { loadingOverlay.style.display = 'none'; }, 3000); // Hide after error
        } finally {
            setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500); // Hide after success
        }
    }

    async function processDataWithMatching() {
        const messageToJobMap = new Map();
        kayitZinciri.forEach(row => {
            if (row['İş ID'] && row['Mesaj ID']) messageToJobMap.set(row['Mesaj ID'], row['İş ID']);
        });

        documents = documents.map(row => {
             if (!row['İş ID']) {
                 let jobId = messageToJobMap.get(row['Mesaj ID']) || messageToJobMap.get(row['Yanıtlanan Mesaj ID']);
                 if (jobId) row['İş ID'] = jobId;
             }
             return row;
        });

        // Extract unique people and departments from all tasks
        people.clear();
        departments.clear();
        allTasks.forEach(task => {
            if (task.Sorumlular) task.Sorumlular.split(',').forEach(p => p.trim() && people.add(p.trim()));
            if (task['İlgili Departman(lar)']) task['İlgili Departman(lar)'].split(',').forEach(d => d.trim() && departments.add(d.trim()));
        });
    }

    // --- Filtreleme ---
    function setupFilters() {
        const filtersData = {
            'Talep Eden Makam': new Set(), 'Kaynak / Harici Paydaş': new Set(),
            'İlgili Departman(lar)': new Set(), 'Tetiklenme Türü': new Set(),
            'Görev Tipi': new Set(), 'Öncelik': new Set(),
            'Mevcut Durum': new Set(), 'Sorumlular': new Set()
        };

        allTasks.forEach(task => {
            Object.keys(filtersData).forEach(key => {
                if (task[key]) {
                    const value = String(task[key]).trim();
                    if (!value) return;
                    if (['Sorumlular', 'İlgili Departman(lar)', 'Görev Tipi'].includes(key)) {
                        value.split(',').forEach(val => val.trim() && filtersData[key].add(val.trim()));
                    } else {
                        filtersData[key].add(value);
                    }
                }
            });
        });

        Object.keys(filtersData).forEach(key => {
            const sortedValues = Array.from(filtersData[key]).sort((a, b) => a.localeCompare(b, 'tr'));
            let selectId = '';
            // Map keys to select IDs correctly
            switch (key) {
                case 'Talep Eden Makam': selectId = 'filter-talepEden'; break;
                case 'Kaynak / Harici Paydaş': selectId = 'filter-kaynak'; break;
                case 'İlgili Departman(lar)': selectId = 'filter-ilgiliDepartman'; break;
                case 'Tetiklenme Türü': selectId = 'filter-tetiklenmeTuru'; break;
                case 'Görev Tipi': selectId = 'filter-gorevTipi'; break;
                case 'Öncelik': selectId = 'filter-oncelik'; break;
                case 'Mevcut Durum': selectId = 'filter-mevcutDurum'; break;
                case 'Sorumlular': selectId = 'filter-sorumlu'; break;
            }
            if (selectId) populateFilterSelect(selectId, sortedValues, `Tüm ${key}`);
        });
    }


    function populateFilterSelect(selectId, optionsArray, defaultText) {
        const selectElement = document.getElementById(selectId);
        if (!selectElement) return;
        selectElement.innerHTML = `<option value="">${defaultText}</option>`;
        optionsArray.forEach(option => {
            if (typeof option === 'string' && option.trim()) {
                selectElement.innerHTML += `<option value="${option}">${option}</option>`;
            }
        });
    }

    function getActiveFilters() {
        const filters = {};
        if(filterMenu) { // Check if filterMenu exists
            filters.talepEden = filterMenu.querySelector('#filter-talepEden')?.value || '';
            filters.kaynak = filterMenu.querySelector('#filter-kaynak')?.value || '';
            filters.ilgiliDepartman = filterMenu.querySelector('#filter-ilgiliDepartman')?.value || '';
            filters.tetiklenmeTuru = filterMenu.querySelector('#filter-tetiklenmeTuru')?.value || '';
            filters.gorevTipi = filterMenu.querySelector('#filter-gorevTipi')?.value || '';
            filters.oncelik = filterMenu.querySelector('#filter-oncelik')?.value || '';
            filters.mevcutDurum = filterMenu.querySelector('#filter-mevcutDurum')?.value || '';
            filters.sorumlu = filterMenu.querySelector('#filter-sorumlu')?.value || '';
        }
        filters.search = searchInput ? searchInput.value.toLowerCase() : '';
        return filters;
    }

    function applyFilters(tasksToFilter = allTasks, filters = getActiveFilters()) {
        return tasksToFilter.filter(task => {
             if (!task || !task['İş ID']) return false;

             const searchMatch = !filters.search || Object.values(task).some(v => String(v).toLowerCase().includes(filters.search));
             const makamMatch = !filters.talepEden || task['Talep Eden Makam'] === filters.talepEden;
             const kaynakMatch = !filters.kaynak || task['Kaynak / Harici Paydaş'] === filters.kaynak;
             const deptMatch = !filters.ilgiliDepartman || (task['İlgili Departman(lar)'] && String(task['İlgili Departman(lar)']).includes(filters.ilgiliDepartman));
             const tetiklenmeMatch = !filters.tetiklenmeTuru || task['Tetiklenme Türü'] === filters.tetiklenmeTuru;
             const gorevTipiMatch = !filters.gorevTipi || (task['Görev Tipi'] && String(task['Görev Tipi']).includes(filters.gorevTipi));
             const oncelikMatch = !filters.oncelik || task['Öncelik'] === filters.oncelik;
             const durumMatch = !filters.mevcutDurum || task['Mevcut Durum'] === filters.mevcutDurum;
             const sorumluMatch = !filters.sorumlu || (task.Sorumlular && String(task.Sorumlular).includes(filters.sorumlu));

             return searchMatch && makamMatch && kaynakMatch && deptMatch && tetiklenmeMatch && gorevTipiMatch && oncelikMatch && durumMatch && sorumluMatch;
        });
    }

    function updateActiveFilterCount() {
        const filters = getActiveFilters();
        // Count active filters excluding the search term
        const count = Object.keys(filters).filter(key => key !== 'search' && filters[key]).length;
        const countElement = document.getElementById('active-filter-count');
        if (countElement) {
            if (count > 0) {
                countElement.textContent = `${count} Aktif`;
                countElement.classList.remove('hidden');
            } else {
                countElement.classList.add('hidden');
            }
        }
    }

    // --- Render Fonksiyonları ---
    function applyAndRender() {
        const filteredTasks = applyFilters();
        render(filteredTasks);
        updateActiveFilterCount();
    }

    function render(filteredTasks) {
        if (!mainContent) return;
        mainContent.innerHTML = ''; // Clear previous content

        setActiveViewButton(getViewButtonId(currentView)); // Update active button

        // Detay görünümünde miyiz kontrol et
        if (currentGroupDetail) {
            renderGroupDetailView(currentGroupDetail.name, currentGroupDetail.type, filteredTasks, currentGroupDetail.filter);
        } else {
            // Ana görünümleri render et
            switch (currentView) {
                case 'kanban': renderKanban(filteredTasks); break;
                case 'list': renderEnhancedList(filteredTasks); break;
                case 'grouping': renderGroupingView(filteredTasks); break;
                case 'docs': renderDocsView(filteredTasks); break;
                default: mainContent.innerHTML = `<div class="text-center py-10 text-slate-500">Bilinmeyen görünüm: ${currentView}</div>`;
            }
        }
    }


    // --- Kart Oluşturma ---
    function createEnhancedTaskCard(task) {
        if (!task || !task['İş ID']) return ''; // Geçersiz görevi atla

        const assigned = task.Sorumlular ? task.Sorumlular.split(',').map(p => p.trim()).filter(Boolean) : [];
        const docsCount = documents.filter(d => d['İş ID'] === task['İş ID']).length;

        const renderField = (label, value, iconClass, options = {}) => {
            const displayValue = value && String(value).trim();
            if (!displayValue) return ''; // Değer yoksa veya boşsa gösterme

            let content = '';
            const { isBadge = false, badgeType = '', isMulti = false, isDate = false, isStrong = true } = options;

            if (isBadge) {
                let badgeClass = '';
                 // Öncelik ve Durum için özel badge fonksiyonlarını kullan
                if (label === 'Öncelik') return getPriorityBadge(value, true);
                if (label === 'Mevcut Durum') return getStatusBadge(value, true);
                // Diğer badge'ler
                switch (badgeType) {
                    case 'trigger': badgeClass = 'badge-trigger'; break;
                    case 'department': badgeClass = 'badge-department'; break;
                    case 'type': badgeClass = 'bg-sky-100 text-sky-700 border border-sky-200'; break;
                    default: badgeClass = 'bg-slate-100 text-slate-600 border border-slate-300';
                }
                 content = `<span class="badge ${badgeClass} !py-0.5 !px-2">${displayValue}</span>`;
            } else if (isMulti) {
                const items = displayValue.split(',').map(item => item.trim()).filter(Boolean);
                let itemBadges = items.map(item => {
                     let itemBadgeClass = '';
                     if (label === 'İlgili Departman(lar)') itemBadgeClass = 'badge-department';
                     // Add more types if needed
                     else itemBadgeClass = 'bg-gray-100 text-gray-700 border border-gray-200';
                     return `<span class="badge ${itemBadgeClass} !py-0.5 !px-2 mr-1">${item}</span>`;
                }).join('');
                 content = `<span>${itemBadges}</span>`;
            } else {
                 const textContent = isDate ? (parseCustomDate(displayValue)?.toLocaleDateString('tr-TR') || displayValue) : displayValue;
                 content = isStrong ? `<span class="line-clamp-1">${label ? label + ': ' : ''}<strong>${textContent}</strong></span>`
                                    : `<span class="line-clamp-1">${label ? label + ': ' : ''}${textContent}</span>`;
            }

            const iconColor = (label === 'Son Teslim Tarihi' && displayValue) ? 'text-red-500' : 'text-slate-400';

            return `<div class="card-field"><i class="ph ${iconClass} ${iconColor}"></i>${content}</div>`;
        };


        return `
        <div class="voyage-card p-4 cursor-pointer transition-all duration-200 flex flex-col justify-between h-full ${getPriorityClass(task.Öncelik)}" data-task-id="${task['İş ID']}">
            <div>
                <div class="flex items-start justify-between mb-2">
                    <h3 class="font-semibold text-slate-800 text-sm leading-tight flex-1 pr-2 line-clamp-2">${task.Başlık || 'Başlıksız Görev'}</h3>
                    ${renderField('Öncelik', task.Öncelik, '', { isBadge: true })}
                </div>

                ${task['Görev İçeriği'] ? `<p class="text-xs text-slate-600 mb-3 line-clamp-2 leading-relaxed">${task['Görev İçeriği']}</p>` : ''}

                <div class="space-y-1 mb-3 text-xs">
                    ${renderField('', task['Mevcut Durum'], '', { isBadge: true, badgeType: 'status' })}
                    ${renderField('Talep Eden', task['Talep Eden Makam'], 'ph-buildings', { isStrong: false})}
                    ${renderField('Kaynak', task['Kaynak / Harici Paydaş'], 'ph-link', { isStrong: false })}
                    ${renderField('Departman', task['İlgili Departman(lar)'], 'ph-users-three', { isMulti: true })}
                    ${renderField('', task['Tetiklenme Türü'], 'ph-sparkle', { isBadge: true, badgeType: 'trigger' })}
                    ${renderField('', task['Görev Tipi'], 'ph-tag', { isBadge: true, badgeType: 'type' })}
                    ${renderField('Onay Adımı', task['Aktif Onay Adımı'], 'ph-check-circle', { isStrong: false })}
                    ${renderField('Son Teslim', task['Son Teslim Tarihi'], 'ph-calendar', { isDate: true })}
                    ${renderField('Oluşturma', task['Oluşturulma Tarihi'], 'ph-clock', { isDate: true, isStrong: false })}
                </div>
            </div>

            <div>
                <div class="flex items-center justify-between pt-2 border-t border-slate-100">
                    <div class="flex items-center gap-2 text-xs text-slate-500">
                        <span class="flex items-center gap-1" title="Belgeler">
                            <i class="ph ph-file text-xs"></i>${docsCount}
                        </span>
                        ${task['İş ID'] ? `<span class="font-mono text-slate-400">#${task['İş ID'].substring(0, 6)}</span>` : ''}
                    </div>
                    <div class="flex items-center -space-x-1.5">
                        ${assigned.slice(0, 3).map(p => `
                            <div class="w-5 h-5 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[10px] text-white font-medium border border-white" title="${p}">${p.charAt(0).toUpperCase()}</div>
                        `).join('')}
                        ${assigned.length > 3 ? `
                            <div class="w-5 h-5 rounded-full bg-slate-300 flex items-center justify-center text-[10px] text-slate-600 font-medium border border-white" title="${assigned.length - 3} kişi daha">+${assigned.length - 3}</div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    // --- Ana Görünümler (Kanban, List, Grouping, Docs) ---
    function renderKanban(filteredTasks) {
        const statuses = [...new Set(allTasks.map(t => t['Mevcut Durum']).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'tr'));
        const wrapper = document.createElement('div');
        wrapper.className = 'kanban-board max-w-none';

        const renderColumn = (title, tasks, bgColor = 'bg-slate-50') => {
            const col = document.createElement('div');
            col.className = `kanban-column p-4 ${bgColor}`; // Padding eklendi
            col.innerHTML = `
                <div class="flex items-center justify-between mb-4 px-2">
                    <h2 class="text-base font-semibold text-slate-700">${title}</h2>
                    <span class="bg-slate-200 text-slate-600 px-2.5 py-0.5 rounded-full text-xs font-medium">${tasks.length}</span>
                </div>
                <div class="kanban-tasks space-y-3">
                    ${tasks.length > 0 ? tasks.map(createEnhancedTaskCard).join('') : '<div class="text-center py-10 text-sm text-slate-500"><i class="ph ph-stack text-3xl mb-2 block"></i>Görev yok</div>'}
                </div>
            `;
            return col;
        };

        const tasksWithoutStatus = filteredTasks.filter(t => !t['Mevcut Durum']);
        if (tasksWithoutStatus.length > 0) {
            wrapper.appendChild(renderColumn('Durumu Belirsiz', tasksWithoutStatus));
        }

        statuses.forEach(status => {
            const tasksInStatus = filteredTasks.filter(t => t['Mevcut Durum'] === status);
             // Sadece içinde görev olan veya durumu belirsiz olmayan sütunları göster
            if(tasksInStatus.length > 0) {
                wrapper.appendChild(renderColumn(status, tasksInStatus, 'bg-white')); // Normal sütunlar beyaz
            }
        });

        if (wrapper.children.length === 0) {
            mainContent.innerHTML = `<div class="text-center py-16 text-slate-500"><i class="ph ph-trello-logo text-5xl mb-3 block"></i>${filteredTasks.length === 0 && allTasks.length > 0 ? 'Filtre sonucu görev bulunamadı.' : 'Gösterilecek görev yok.'}</div>`;
        } else {
            mainContent.appendChild(wrapper);
        }
    }

    function renderEnhancedList(filteredTasks) {
         // Liste görünümü önceki gibi kalabilir veya özet kartlarına benzer şekilde yeniden tasarlanabilir.
         // Şimdilik önceki halini koruyalım, gerekirse güncelleriz.
        mainContent.innerHTML = `
            <div class="glass rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Başlık</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Sorumlu</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Durum</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Öncelik</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Son Teslim</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Belge</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${filteredTasks.map(task => {
                                const docsCount = documents.filter(d => d['İş ID'] === task['İş ID']).length;
                                const assigned = task.Sorumlular ? task.Sorumlular.split(',').map(p=>p.trim()).filter(Boolean) : [];
                                return `
                                    <tr class="hover:bg-slate-50 transition cursor-pointer" data-task-id="${task['İş ID']}">
                                        <td class="px-4 py-2.5 whitespace-nowrap max-w-sm">
                                            <div class="font-medium text-slate-700 mb-0.5 truncate">${task.Başlık || 'Başlık Yok'}</div>
                                            <div class="text-xs text-slate-400">${task['İş ID']}</div>
                                        </td>
                                        <td class="px-4 py-2.5">
                                             <div class="flex items-center -space-x-1.5">
                                                ${assigned.slice(0, 3).map(p => `<div class="w-6 h-6 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-[10px] text-white font-medium border border-white" title="${p}">${p.charAt(0).toUpperCase()}</div>`).join('')}
                                                ${assigned.length > 3 ? `<div class="w-6 h-6 rounded-full bg-slate-300 flex items-center justify-center text-[10px] text-slate-600 font-medium border border-white">+${assigned.length - 3}</div>` : ''}
                                                ${assigned.length === 0 ? '<span class="text-xs text-slate-400">-</span>' : ''}
                                            </div>
                                        </td>
                                        <td class="px-4 py-2.5 whitespace-nowrap">${getStatusBadge(task['Mevcut Durum'], true)}</td>
                                        <td class="px-4 py-2.5 whitespace-nowrap">${getPriorityBadge(task.Öncelik, true)}</td>
                                        <td class="px-4 py-2.5 text-slate-600 whitespace-nowrap">${task['Son Teslim Tarihi'] || '-'}</td>
                                        <td class="px-4 py-2.5 text-center">
                                            <span class="text-xs text-slate-500">${docsCount}</span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                             ${filteredTasks.length === 0 ? `<tr><td colspan="6" class="text-center py-10 text-slate-500">Gösterilecek görev bulunamadı.</td></tr>` : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    function renderGroupingView(filteredTasks) {
        mainContent.innerHTML = `
            <div class="mb-6 flex justify-between items-center">
                 <h1 class="view-title">Görev Grupları</h1>
                 <div class="grouping-controls flex items-center gap-1 p-1 bg-slate-200 rounded-lg">
                    <button id="group-by-person" class="px-3 py-1 text-sm font-medium rounded-md ${currentGroupingType === 'person' ? 'active' : 'text-slate-600 hover:bg-slate-300'}">
                        <i class="ph ph-user mr-1"></i> Kişiye Göre
                    </button>
                    <button id="group-by-department" class="px-3 py-1 text-sm font-medium rounded-md ${currentGroupingType === 'department' ? 'active' : 'text-slate-600 hover:bg-slate-300'}">
                        <i class="ph ph-buildings mr-1"></i> Departmana Göre
                    </button>
                 </div>
            </div>
            <div id="summary-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Özet kartları buraya gelecek --></div>
        `;

        const groupKey = currentGroupingType === 'person' ? 'Sorumlular' : 'İlgili Departman(lar)';
        const groups = {};

        filteredTasks.forEach(task => {
            const groupValues = task[groupKey] ? String(task[groupKey]).split(',').map(v => v.trim()).filter(Boolean) : ['Belirtilmemiş'];
            groupValues.forEach(groupName => {
                if (!groups[groupName]) {
                    groups[groupName] = [];
                }
                groups[groupName].push(task);
            });
        });

        const container = document.getElementById('summary-cards-container');
        container.innerHTML = ''; // Önceki kartları temizle

        Object.keys(groups).sort((a,b) => a.localeCompare(b,'tr')).forEach(groupName => {
            container.innerHTML += createSummaryCard(groupName, groups[groupName], currentGroupingType);
        });

        if (Object.keys(groups).length === 0) {
             container.innerHTML = `<div class="col-span-full text-center py-16 text-slate-500"><i class="ph ph-chart-pie-slice text-5xl mb-3 block"></i>Gruplanacak görev bulunamadı.</div>`;
        }

        // Grup türü değiştirme butonlarına event listener ekle
        document.getElementById('group-by-person')?.addEventListener('click', () => {
            currentGroupingType = 'person';
            applyAndRender(); // Re-render with new grouping
        });
        document.getElementById('group-by-department')?.addEventListener('click', () => {
            currentGroupingType = 'department';
            applyAndRender(); // Re-render with new grouping
        });
    }

    function createSummaryCard(groupName, tasksInGroup, groupType) {
        const totalTasks = tasksInGroup.length;
        const statusCounts = tasksInGroup.reduce((acc, task) => {
            const status = task['Mevcut Durum'] || 'Belirsiz';
            acc[status] = (acc[status] || 0) + 1;
            return acc;
        }, {});
        const priorityCounts = tasksInGroup.reduce((acc, task) => {
            const priority = task['Öncelik'] || 'Belirsiz';
            acc[priority] = (acc[priority] || 0) + 1;
            return acc;
        }, {});

        const groupIcon = groupType === 'person' ? 'ph-user' : 'ph-buildings';

         // Durumları sırala (örneğin: Yeni, Devam Ediyor, Tamamlandı, Belirsiz)
        const sortedStatuses = Object.keys(statusCounts).sort((a, b) => {
            const order = {'Yeni': 1, 'Devam Ediyor': 2, 'Beklemede': 3, 'Tamamlandı': 4, 'İptal': 5, 'Belirsiz': 6}; // Örnek sıralama
            return (order[a] || 99) - (order[b] || 99);
        });
         // Öncelikleri sırala (Kritik, Yüksek, Normal, Düşük, Belirsiz)
         const sortedPriorities = Object.keys(priorityCounts).sort((a, b) => {
             const order = {'Kritik': 1, 'Yüksek': 2, 'Normal': 3, 'Düşük': 4, 'Belirsiz': 5};
             return (order[a] || 99) - (order[b] || 99);
         });


        return `
        <div class="summary-card glass rounded-lg p-4 transition duration-150 ease-in-out" data-group-name="${groupName}" data-group-type="${groupType}">
            <div class="flex items-center gap-3 mb-3">
                 <div class="w-8 h-8 rounded-full bg-gradient-to-br from-gray-300 to-gray-400 flex items-center justify-center flex-shrink-0">
                     <i class="ph ${groupIcon} text-lg text-white"></i>
                 </div>
                <h3 class="font-semibold text-slate-800 text-base line-clamp-1">${groupName}</h3>
                <span class="ml-auto bg-blue-100 text-blue-700 px-2.5 py-0.5 rounded-full text-xs font-medium">${totalTasks} Görev</span>
            </div>

            <div class="mb-3">
                 <p class="text-xs font-medium text-slate-500 mb-1">Duruma Göre:</p>
                 <div class="flex flex-wrap gap-x-3 gap-y-1">
                     ${sortedStatuses.map(status => `
                         <div class="status-count-item flex items-center gap-1.5 text-xs text-slate-600 rounded p-0.5" data-status-filter="${status}">
                             ${getStatusBadge(status, true)}
                             <span class="font-medium">${statusCounts[status]}</span>
                         </div>
                     `).join('')}
                 </div>
            </div>

            <div>
                 <p class="text-xs font-medium text-slate-500 mb-1">Önceliğe Göre:</p>
                 <div class="flex flex-wrap gap-x-3 gap-y-1">
                    ${sortedPriorities.map(priority => `
                         <div class="priority-count-item flex items-center gap-1.5 text-xs text-slate-600 rounded p-0.5" data-priority-filter="${priority}">
                              ${getPriorityBadge(priority, true)}
                             <span class="font-medium">${priorityCounts[priority]}</span>
                         </div>
                    `).join('')}
                 </div>
            </div>
        </div>
        `;
    }

     function renderGroupDetailView(groupName, groupType, allFilteredTasks, specificFilter = null) {
         mainContent.innerHTML = ''; // Önce temizle

         const groupKey = groupType === 'person' ? 'Sorumlular' : 'İlgili Departman(lar)';
         let tasksInGroup = allFilteredTasks.filter(task => {
             const groupValues = task[groupKey] ? String(task[groupKey]).split(',').map(v => v.trim()).filter(Boolean) : ['Belirtilmemiş'];
             return groupValues.includes(groupName);
         });

         let filterDescription = '';
          // Eğer durum veya öncelik filtresi varsa uygula
         if (specificFilter) {
             if (specificFilter.type === 'status') {
                 tasksInGroup = tasksInGroup.filter(task => (task['Mevcut Durum'] || 'Belirsiz') === specificFilter.value);
                 filterDescription = ` - Durum: ${specificFilter.value}`;
             } else if (specificFilter.type === 'priority') {
                 tasksInGroup = tasksInGroup.filter(task => (task['Öncelik'] || 'Belirsiz') === specificFilter.value);
                  filterDescription = ` - Öncelik: ${specificFilter.value}`;
             }
         }


         const backButton = document.createElement('button');
         backButton.className = 'back-button';
         backButton.innerHTML = `<i class="ph ph-arrow-left"></i> Geri Dön`;
         backButton.onclick = () => {
             currentGroupDetail = null; // Detay görünümünden çık
             applyAndRender();
         };
         mainContent.appendChild(backButton);


         const title = document.createElement('h1');
         title.className = 'view-title';
         title.textContent = `${groupName} ${filterDescription} (${tasksInGroup.length} Görev)`;
         mainContent.appendChild(title);

         const tasksContainer = document.createElement('div');
         tasksContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4'; // Kartlar için grid yapısı

         if (tasksInGroup.length > 0) {
             tasksContainer.innerHTML = tasksInGroup
                 .sort((a,b) => (a.Başlık || '').localeCompare(b.Başlık || '', 'tr')) // Görevleri başlığa göre sırala
                 .map(createEnhancedTaskCard).join('');
         } else {
             tasksContainer.innerHTML = `<div class="col-span-full text-center py-16 text-slate-500"><i class="ph ph-list-checks text-5xl mb-3 block"></i>Bu grup için görev bulunamadı.</div>`;
         }
          mainContent.appendChild(tasksContainer);
     }


    function renderDocsView(filteredTasks) {
         // Belge görünümü önceki gibi
        const docsByTask = {};
        const filteredTaskIds = new Set(filteredTasks.map(t => t['İş ID']));

        documents.forEach(doc => {
            if (doc['İş ID'] && filteredTaskIds.has(doc['İş ID'])) {
                if (!docsByTask[doc['İş ID']]) {
                    const task = allTasks.find(t => t['İş ID'] === doc['İş ID']);
                    docsByTask[doc['İş ID']] = {
                        title: task ? task.Başlık : `Görev ${doc['İş ID']}`,
                        docs: []
                    };
                }
                docsByTask[doc['İş ID']].docs.push(doc);
            }
        });

        mainContent.innerHTML = `<h1 class="view-title">Görev Belgeleri</h1>`; // Başlık eklendi
        const container = document.createElement('div');
        container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4'; // Boşluk azaltıldı

        Object.keys(docsByTask).sort((a,b) => docsByTask[a].title.localeCompare(docsByTask[b].title, 'tr')).forEach(taskId => {
            container.innerHTML += `
                <div class="voyage-card p-4 flex flex-col">
                    <h2 class="font-semibold text-slate-700 mb-3 text-sm flex-shrink-0">${docsByTask[taskId].title}</h2>
                    <div class="space-y-2 flex-grow overflow-y-auto max-h-80 pr-1">
                        ${docsByTask[taskId].docs
                            .sort((a,b) => (a.Başlık || '').localeCompare(b.Başlık || '', 'tr'))
                            .map(doc => `
                            <a href="${doc.Link}" target="_blank" rel="noopener noreferrer"
                               class="document-card bg-slate-50 p-2.5 block group rounded-md border border-slate-200 hover:bg-blue-50 hover:border-blue-300 transition duration-150">
                                <div class="flex items-center gap-2">
                                    <div class="w-7 h-7 rounded bg-blue-100 flex items-center justify-center flex-shrink-0">
                                        <i class="ph ph-file-arrow-down text-base text-blue-600"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-medium text-slate-700 text-xs truncate group-hover:text-blue-600 transition">${doc.Başlık || 'İsimsiz Belge'}</h4>
                                        <p class="text-[11px] text-slate-500">${doc.Gönderen || '?'} - ${parseCustomDate(doc['Oluşturulma Tarihi'])?.toLocaleDateString('tr-TR') || '-'}</p>
                                    </div>
                                    <i class="ph ph-arrow-square-out text-slate-400 group-hover:text-blue-500 transition ml-auto text-sm"></i>
                                </div>
                            </a>
                        `).join('')}
                         ${docsByTask[taskId].docs.length === 0 ? `<p class="text-xs text-slate-500">Belge yok.</p>` : ''}
                    </div>
                </div>
            `;
        });
        mainContent.appendChild(container);

        if (Object.keys(docsByTask).length === 0) {
             mainContent.innerHTML += `<div class="text-center py-16 text-slate-500"><i class="ph ph-files text-5xl mb-3 block"></i>Filtrelere uygun görevlere ait belge bulunamadı.</div>`;
        }
    }


    // --- Modal Fonksiyonları ---
    function openTaskModal(taskId) {
        const task = allTasks.find(t => t['İş ID'] === taskId);
        if (!task) return;

        document.getElementById('modal-title').textContent = task.Başlık || 'Başlık Yok';
        document.getElementById('modal-id').textContent = task['İş ID'];
        document.getElementById('modal-priority-badge').innerHTML = getPriorityBadge(task.Öncelik);
        document.getElementById('modal-status-badge').innerHTML = getStatusBadge(task['Mevcut Durum']);
        document.getElementById('modal-trigger-type').innerHTML = task['Tetiklenme Türü'] ? `<span class="badge badge-trigger">${task['Tetiklenme Türü']}</span>` : '';


        const detailsContainer = document.getElementById('modal-details');
        detailsContainer.innerHTML = [
            { label: 'Talep Eden', value: task['Talep Eden Makam'] },
            { label: 'Kaynak', value: task['Kaynak / Harici Paydaş'] },
            { label: 'Görev Tipi', value: task['Görev Tipi'] },
            { label: 'Oluşturulma Tarihi', value: task['Oluşturulma Tarihi'] },
            { label: 'Son Teslim Tarihi', value: task['Son Teslim Tarihi'] },
        ]
        .filter(item => item.value && String(item.value).trim()) // Sadece dolu olanları göster
        .map(item => `<p><strong>${item.label}:</strong> ${item.value}</p>`)
        .join('')
        + (task['Görev İçeriği'] ? `<p class="mt-3"><strong>Açıklama:</strong><br>${task['Görev İçeriği']}</p>` : '<p class="mt-3 text-slate-500">Açıklama yok</p>');


        const teamContainer = document.getElementById('modal-team');
        const responsibles = task.Sorumlular ? task.Sorumlular.split(',').map(n => n.trim()).filter(Boolean) : [];
        const relatedDepts = task['İlgili Departman(lar)'] ? task['İlgili Departman(lar)'].split(',').map(n => n.trim()).filter(Boolean) : [];

        teamContainer.innerHTML = `
             <div class="mb-2">
                <strong>Sorumlular:</strong>
                ${responsibles.length > 0 ? responsibles.map(p => `<span class="ml-1.5 inline-flex items-center gap-1 bg-gray-100 px-2 py-0.5 rounded text-xs font-medium text-gray-700"><i class="ph ph-user text-xs"></i>${p}</span>`).join('') : '<span class="text-gray-500 ml-1"> Belirtilmemiş</span>'}
            </div>
             <div class="mb-2">
                <strong>İlgili Departmanlar:</strong>
                 ${relatedDepts.length > 0 ? relatedDepts.map(d => `<span class="ml-1.5 inline-flex items-center gap-1 bg-indigo-100 px-2 py-0.5 rounded text-xs font-medium text-indigo-700"><i class="ph ph-buildings text-xs"></i>${d}</span>`).join('') : '<span class="text-gray-500 ml-1"> Belirtilmemiş</span>'}
             </div>
              ${task['Aktif Onay Adımı'] ? `<p><strong>Aktif Onay Adımı:</strong> ${task['Aktif Onay Adımı']}</p>` : ''}
             ${task['Onay Verecek Kişi'] ? `<p><strong>Onay Verecek Kişi:</strong> ${task['Onay Verecek Kişi']}</p>` : ''}
        `;

         switchModalTab('workflow', task); // Varsayılan olarak İş Akışını aç

        taskModal.style.display = 'flex'; // Use style.display
    }

    function switchModalTab(tabId, task) {
        if (!task) return;

        modalTabs.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'text-blue-600'));
        modalTabs.querySelector(`[data-tab="${tabId}"]`)?.classList.add('active', 'text-blue-600');

        tabContent.innerHTML = '<div class="flex justify-center items-center h-40"><div class="loading-spinner w-6 h-6"></div></div>'; // Smaller spinner

        setTimeout(() => {
            if (tabId === 'workflow') renderWorkflowTab(task);
            else if (tabId === 'docs') renderDocumentsTab(task['İş ID']);
            else tabContent.innerHTML = `<p class="text-slate-500 text-sm">İçerik bulunamadı.</p>`;
        }, 50);
    }

    function formatWorkflow(workflowText) {
        if (!workflowText || String(workflowText).trim() === '') {
            return '<p class="text-slate-500 text-sm">İş akışı bilgisi yok.</p>';
        }
        const items = workflowText.split('- ').filter(item => item.trim() !== '');
        if (items.length <= 1 && !workflowText.startsWith('- ')) {
             return `<p class="text-sm text-slate-700">${workflowText}</p>`;
        }
        return `<ul class="list-disc list-inside space-y-1.5 text-sm text-slate-700">
                   ${items.map(item => `<li>${item.trim()}</li>`).join('')}
                </ul>`;
    }

    function renderWorkflowTab(task) {
         tabContent.innerHTML = `
            <h4 class="font-semibold text-base mb-3 text-slate-700">İş Akışı</h4>
            ${formatWorkflow(task['İş Akışı'])}
         `;
    }

    function renderDocumentsTab(taskId) {
        const taskDocs = documents
            .filter(d => d['İş ID'] === taskId)
             .sort((a,b) => (a.Başlık || '').localeCompare(b.Başlık || '', 'tr'));

        if (taskDocs.length === 0) {
            tabContent.innerHTML = '<p class="text-slate-500 text-sm">Bu görev için belge bulunamadı.</p>';
            return;
        }

        tabContent.innerHTML = `
            <h4 class="font-semibold text-base mb-3 text-slate-700">Belgeler (${taskDocs.length})</h4>
            <div class="space-y-2 max-h-[350px] overflow-y-auto pr-2">
                ${taskDocs.map(doc => `
                    <a href="${doc.Link}" target="_blank" rel="noopener noreferrer"
                       class="document-card bg-slate-50 p-2.5 block group rounded-md border border-slate-200 hover:bg-blue-50 hover:border-blue-300 transition duration-150">
                        <div class="flex items-center gap-2.5">
                            <div class="w-7 h-7 rounded bg-blue-100 flex items-center justify-center flex-shrink-0">
                                <i class="ph ph-file-arrow-down text-base text-blue-600"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-medium text-slate-700 text-xs truncate group-hover:text-blue-600 transition">${doc.Başlık || 'İsimsiz Belge'}</h4>
                                <p class="text-[11px] text-slate-500">${doc.Gönderen || '?'} - ${parseCustomDate(doc['Oluşturulma Tarihi'])?.toLocaleDateString('tr-TR') || '-'}</p>
                            </div>
                            <i class="ph ph-arrow-square-out text-slate-400 group-hover:text-blue-500 transition ml-auto text-sm"></i>
                        </div>
                    </a>
                `).join('')}
            </div>
        `;
    }

    // --- Event Listeners ---
    function setupEventListeners() {
        searchInput?.addEventListener('input', applyAndRender);
        syncBtn?.addEventListener('click', async () => {
            // Sync logic from previous versions...
             syncBtn.disabled = true;
             syncBtn.classList.add('opacity-50', 'cursor-not-allowed'); // Görsel geri bildirim
             syncBtn.innerHTML = '<i class="ph-bold ph-spinner text-lg animate-spin"></i>';
            try {
                await fetchData(); // fetchData already calls applyAndRender
                syncBtn.innerHTML = '<i class="ph-bold ph-check text-lg text-green-500"></i>';
            } catch (error) {
                syncBtn.innerHTML = '<i class="ph-bold ph-warning text-lg text-red-500"></i>';
            } finally {
                setTimeout(() => {
                    syncBtn.innerHTML = '<i class="ph-bold ph-arrows-clockwise text-lg"></i>';
                    syncBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    syncBtn.disabled = false;
                }, 2000);
            }
        });

        // Filter Menu
        document.getElementById('open-filter-btn')?.addEventListener('click', openFilterMenu);
        document.getElementById('close-filter-btn')?.addEventListener('click', closeFilterMenu);
        filterMenuBackdrop?.addEventListener('click', closeFilterMenu);
        document.getElementById('reset-filters-btn')?.addEventListener('click', () => {
            if(filterMenu) { // Check if filterMenu exists
                filterMenu.querySelectorAll('select').forEach(s => s.value = '');
                filterMenu.querySelectorAll('input').forEach(i => i.value = '');
            }
            applyAndRender();
        });
        document.getElementById('apply-filters-btn')?.addEventListener('click', () => {
            applyAndRender();
            closeFilterMenu();
        });

        // View Buttons
        document.getElementById('view-toggle-kanban')?.addEventListener('click', () => { currentView = 'kanban'; currentGroupDetail = null; applyAndRender(); });
        document.getElementById('view-toggle-list')?.addEventListener('click', () => { currentView = 'list'; currentGroupDetail = null; applyAndRender(); });
        document.getElementById('view-grouping')?.addEventListener('click', () => { currentView = 'grouping'; currentGroupDetail = null; applyAndRender(); });
        document.getElementById('view-docs')?.addEventListener('click', () => { currentView = 'docs'; currentGroupDetail = null; applyAndRender(); });


        // Modal
        closeModalBtn?.addEventListener('click', () => taskModal.style.display = 'none');
        taskModal?.addEventListener('click', (e) => { if (e.target === taskModal) taskModal.style.display = 'none'; });
        modalTabs?.addEventListener('click', (e) => {
            const tabButton = e.target.closest('.tab-btn');
            if (tabButton && tabButton.dataset.tab) {
                const taskId = document.getElementById('modal-id')?.textContent;
                const task = allTasks.find(t => t['İş ID'] === taskId);
                if (task) switchModalTab(tabButton.dataset.tab, task);
            }
        });

        // Main Content Delegation for Clicks
        mainContent?.addEventListener('click', (e) => {
            const taskCard = e.target.closest('[data-task-id]');
            const summaryCard = e.target.closest('.summary-card');
             const statusFilter = e.target.closest('.status-count-item');
             const priorityFilter = e.target.closest('.priority-count-item');


            if (taskCard && taskCard.dataset.taskId) {
                openTaskModal(taskCard.dataset.taskId);
            } else if (summaryCard && summaryCard.dataset.groupName && summaryCard.dataset.groupType) {
                 // Özet kartına tıklandı -> Detay görünümünü aç
                currentGroupDetail = {
                    type: summaryCard.dataset.groupType,
                    name: summaryCard.dataset.groupName,
                    filter: null // Başlangıçta filtre yok
                };
                applyAndRender(); // Detay görünümünü render et
            } else if (statusFilter && statusFilter.dataset.statusFilter && currentGroupDetail) {
                 // Durum filtresine tıklandı -> Detay görünümünü filtrele
                 currentGroupDetail.filter = { type: 'status', value: statusFilter.dataset.statusFilter };
                 applyAndRender();
            } else if (priorityFilter && priorityFilter.dataset.priorityFilter && currentGroupDetail) {
                // Öncelik filtresine tıklandı -> Detay görünümünü filtrele
                currentGroupDetail.filter = { type: 'priority', value: priorityFilter.dataset.priorityFilter };
                applyAndRender();
            }
        });
    }

    // --- Yardımcı UI Fonksiyonları ---
    function updateSyncIndicator() {
        if (lastSyncTime && syncTimeSpan && lastSyncDiv) {
            syncTimeSpan.textContent = `Son Eşitleme: ${lastSyncTime.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
            lastSyncDiv.classList.remove('hidden');
        }
    }

    function openFilterMenu() {
        if (filterMenu && filterMenuBackdrop) {
            filterMenuBackdrop.classList.remove('hidden');
            filterMenu.classList.add('open');
            setTimeout(() => filterMenuBackdrop.classList.add('opacity-100'), 10);
        }
    }

    function closeFilterMenu() {
        if (filterMenu && filterMenuBackdrop) {
            filterMenuBackdrop.classList.remove('opacity-100');
            filterMenu.classList.remove('open');
            setTimeout(() => filterMenuBackdrop.classList.add('hidden'), 300);
        }
    }

    function getViewButtonId(viewName) {
         switch (viewName) {
             case 'kanban': return 'view-toggle-kanban';
             case 'list': return 'view-toggle-list';
             case 'grouping': return 'view-grouping';
             case 'docs': return 'view-docs';
             default: return '';
         }
     }

     function setActiveViewButton(activeButtonId) {
         ['view-toggle-kanban', 'view-toggle-list', 'view-grouping', 'view-docs'].forEach(id => {
             const btn = document.getElementById(id);
             if (btn) {
                 btn.classList.remove('bg-blue-100', 'text-blue-700', 'bg-cyan-500', 'text-white'); // Aktif stilleri kaldır
                 btn.classList.add('text-slate-600', 'hover:bg-slate-100'); // Pasif stil
             }
         });
         const activeButton = document.getElementById(activeButtonId);
         if (activeButton) {
             activeButton.classList.remove('text-slate-600', 'hover:bg-slate-100');
             activeButton.classList.add('bg-blue-100', 'text-blue-700'); // Yeni aktif stil
         }
     }


    // --- Başlangıç ---
    setupEventListeners();
    fetchData(); // İlk veri yükleme ve render

    // Periyodik yenileme (isteğe bağlı)
    // setInterval(fetchData, 5 * 60 * 1000);

});
</script>
</body>
</html>

